import "math"
import "pe"

rule BumbleBee_VHD_drops_LNK
{
    strings:
        $loader =  { 2d 00 6? 00 ?0 00 [ 27 - 47 ] 00 2e 00 7? 00 73 00 ?? 00 22 00 25 }
        $hex_3e9 = { 58 00 00 00 00 00 00 00 73 65 72 76 65 72 }
    condition:
        all of them
}

rule Classification_Bumblebee {
    meta:
        author = "Jeremy Humble, muzi"
        date = "2022-04-27"
        references = "https://www.proofpoint.com/us/blog/threat-insight/bumblebee-is-still-transforming?utm_source=social_organic&utm_social_network=twitter&utm_campaign=ThreatInsight&utm_post_id=9e1ef49d-6b04-430c-b52f-3b4df259cf03"
        description = "Detects BumbleBee Loader used by EXOTIC LILY. Crypted version: e681605534c019d0e6e8095edc9bb006 "
        malware_family = "BumbleBee"
        threat_actor = "EXOTIC LILY"
        hashes = "1a7a701a6c849e3cbac53dcfb511dd5a56f472cf"


    strings:
        /*
           18003c239 80 f9 eb        CMP        CL,0xeb
           18003c23c 75 35           JNZ        LAB_18003c273
           18003c23e 80 7b 02 90     CMP        byte ptr [RBX + 0x2],0x90
           18003c242 75 2f           JNZ        LAB_18003c273
           18003c244 80 7b 03 90     CMP        byte ptr [RBX + 0x3],0x90
           18003c248 75 29           JNZ        LAB_18003c273
           18003c24a 80 7b 04 90     CMP        byte ptr [RBX + 0x4],0x90
           18003c24e 75 23           JNZ        LAB_18003c273
           18003c250 c6 02 e9        MOV        byte ptr [RDX],0xe9
           18003c253 8a 43 01        MOV        AL,byte ptr [RBX + 0x1]
        */
        $check_hooks = {
                            (80 F?| 3C) EB                      [0-16]
                            80 (78|79|7A|7B|7D|7E|7F) 02 90     [0-16]
                            80 (78|79|7A|7B|7D|7E|7F) 03 90     [0-16]
                            80 (78|79|7A|7B|7D|7E|7F) 04 90
                        }

        $high_check_hooks = {
                                (80 F?| 3C) EB                      [0-16]
                                80 (78|79|7A|7B|7D|7E|7F) 02 90     [0-16]
                                80 (78|79|7A|7B|7D|7E|7F) 03 90     [0-16]
                                80 (78|79|7A|7B|7D|7E|7F) 04 90     [0-64]
                                FF 25
                            }

        // shidijdex\wab.exe
        $command0 = "\x00shi\x00"
        $command1 = "\x00dij\x00"
        $command2 = "\x00dex\x00"
        $command3 = "\x00sdl\x00"
        $command4 = "\x00ins\x00"

        $inject0 = "\\wab.exe" fullword
        $inject1 = "\\Windows Mail\\wabmig.exe" fullword
        $inject2 = "\\Windows Mail\\wab.exe" fullword
        $inject3 = "\\Windows Photo Viewer\\ImagingDevices.exe" fullword


        /*
            0000000002068022 | C745 D0 4831C048             | mov dword ptr ss:[rbp-30],48C03148     |
            0000000002068029 | 48:8D0D 00EC1900             | lea rcx,qword ptr ds:[2206C30]         |
            0000000002068030 | C745 D4 31DA4831             | mov dword ptr ss:[rbp-2C],3148DA31     |
            0000000002068037 | C745 D8 C9B9E803             | mov dword ptr ss:[rbp-28],3E8B9C9      |
            000000000206803E | C745 DC 0000BA01             | mov dword ptr ss:[rbp-24],1BA0000      |
            0000000002068045 | C745 E0 00000048             | mov dword ptr ss:[rbp-20],48000000     |
            000000000206804C | C745 E4 B8887766             | mov dword ptr ss:[rbp-1C],667788B8     |
            0000000002068053 | C745 E8 55443322             | mov dword ptr ss:[rbp-18],22334455     |
            000000000206805A | C745 EC 11FFD0EB             | mov dword ptr ss:[rbp-14],EBD0FF11     |
        */
        $injection_shellcode0 = {48 31 C0 48 [0-16] 31 DA 48 31 [0-16] C9 B9 E8 03}
        $injection_shellcode1 = {C7 4? ?? 11 FF D0 EB}



    condition:
        $high_check_hooks or
        any of ($injection*) or
        (
            $check_hooks and
            (
                1 of ($inject*) or
                1 of ($command*)
            )
        ) or
        (
            1 of ($inject*) and
            1 of ($command*)
        ) or
        (
            uint16(0) == 0x5A4D and
            filesize < 4MB and
            all of ($command*)
        )
}

rule Bumblebee_PSLoader_Stage_One {
    meta:
        author = "muzi"
        date = "2022-08-21"
        description = "Detects PSLoader Stage 1 used by Bumblebee. Note: This rule is only for the extractor."
        malware_family = "BumbleBee"
        threat_actor = "EXOTIC LILY"
        hashes = "1a7a701a6c849e3cbac53dcfb511dd5a56f472cf"


    strings:
        $b64_gz = "sIAAAAAAAEA" ascii wide

    condition:
        #b64_gz > 50

}
